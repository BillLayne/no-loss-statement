<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Statement of No Loss - Bill Layne Insurance</title>
    
    <style>
        /* General Reset & Box Sizing */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* CSS Variables for Easy Theming */
        :root {
            --primary-color: #1e3c72; /* Deep Indigo */
            --secondary-color: #667eea; /* Vibrant Periwinkle */
            --success-color: #4CAF50;
            --warning-color: #ffc107;
            --info-color: #1976d2;
            --error-color: #dc3545;
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0);
        }
        
        /* Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 10px;
            padding-bottom: calc(20px + var(--safe-area-inset-bottom));
        }
        
        /* Card-Based UI Container */
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            /* Refined shadow for a cleaner, modern look */
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
            margin-bottom: 80px;
        }
        
        /* Header Styling */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .header h2 {
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .agency-contact {
            font-size: 13px;
            margin-top: 15px;
            opacity: 0.95;
        }
        
        /* Mobile Progress Bar */
        .progress-bar {
            display: none;
            height: 4px;
            background: rgba(255,255,255,0.2);
            margin-top: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Form Layout */
        .form-container {
            padding: 30px 20px;
            padding-bottom: 40px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
        }
        
        .form-group {
            margin-bottom: 24px;
            position: relative; /* NEW: for icon positioning */
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 24px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .required {
            color: var(--error-color);
            margin-left: 3px;
        }
        
        /* Modern Input Styling */
        input, select, textarea {
            width: 100%;
            padding: 16px;
            min-height: 52px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px; /* Prevents zoom on iOS */
            transition: all 0.3s;
            background: #f8f9fa;
            -webkit-appearance: none;
            appearance: none;
        }
        
        select {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            /* Subtle ring effect on focus */
            box-shadow: 0 0 0 4px rgba(102,126,24,0.1);
        }

        /* Input field icons */
        .input-icon {
            position: absolute;
            top: 52px;
            right: 15px;
            width: 20px;
            height: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .form-group.is-valid .input-icon.valid-icon,
        .form-group.is-invalid .input-icon.invalid-icon {
            opacity: 1;
        }

        .form-group.is-valid input {
            border-color: var(--success-color);
        }

        .form-group.is-invalid input {
            border-color: var(--error-color);
        }
        
        /* Statement & Legal Text Styling */
        .statement-box {
            background: #f0f4ff;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
        }
        
        .statement-box h3 {
            color: var(--primary-color);
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .statement-box h3::before {
            content: '📋';
            margin-right: 10px;
            font-size: 24px;
        }
        
        .legal-text {
            color: #333;
            font-size: 14px;
            line-height: 1.8;
            margin-bottom: 15px;
            text-align: justify;
        }
        
        .fraud-warning {
            color: #c00; /* Matches Alert Red */
            font-style: italic;
            font-weight: 600;
            background: #fff5f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }

        /* Enhanced Checkbox Styling */
        .checkbox-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            margin: 24px 0;
            border: 2px solid #e0e0e0;
            position: relative;
        }
        
        .consent-highlight {
            background: #fffbeb;
            border-color: var(--warning-color);
        }
        
        .esign-highlight {
            background: #f0f4ff;
            border-color: var(--secondary-color);
        }
        
        .checkbox-container label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            padding-left: 35px; /* Space for custom checkbox */
            min-height: 24px;
            position: relative;
        }
        
        /* Hide original checkbox */
        .checkbox-container input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        /* Create a custom checkbox */
        .checkbox-container .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 24px;
            width: 24px;
            background-color: #fff;
            border: 2px solid #adb5bd;
            border-radius: 6px;
            transition: all 0.2s;
        }

        /* Style the checkmark when checkbox is checked */
        .checkbox-container input[type="checkbox"]:checked ~ .checkmark {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Create the checkmark/indicator (hidden when not checked) */
        .checkbox-container .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        /* Show the checkmark when checked */
        .checkbox-container input[type="checkbox"]:checked ~ .checkmark:after {
            display: block;
        }

        /* Style the checkmark/indicator */
        .checkbox-container .checkmark:after {
            left: 7px;
            top: 3px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 3px 3px 0;
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            transform: rotate(45deg);
        }
        
        /* Signature Pad */
        #signature-pad {
            border: 2px dashed #ddd;
            border-radius: 12px;
            width: 100%;
            height: 200px;
            cursor: crosshair;
            background: white;
            touch-action: none;
        }
        
        .signature-label {
            background: #f0f4ff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
            text-align: center;
            font-size: 14px;
            color: var(--primary-color);
        }
        
        .signature-buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        /* Button Styling */
        .btn {
            padding: 16px 24px;
            min-height: 48px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-clear {
            background: var(--error-color);
            color: white;
            flex: 1;
        }
        
        .btn-clear:hover, .btn-clear:active {
            background: #c00;
            transform: scale(0.98);
        }
        
        .btn-submit {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            width: 100%;
            margin-top: 20px;
            font-size: 18px;
            padding: 18px;
            min-height: 56px;
        }
        
        .btn-submit:hover, .btn-submit:active {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Modals (Loading & Success) */
        .loading-modal-overlay, .success-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .loading-modal-overlay.show, .success-modal-overlay.show {
            display: flex;
        }
        
        .loading-modal, .success-modal {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.4s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--success-color) 0%, #8BC34A 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .success-icon svg {
            width: 40px;
            height: 40px;
            stroke: white;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .confirmation-number {
            background: #f0f4ff;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 15px 0 25px 0;
            font-family: monospace;
            font-size: 16px;
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        /* Footer */
        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
        }
        
        .footer-logo {
            max-width: 150px;
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 10px;
            font-size: 13px;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }

        .powered-by {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #999;
        }
        
        /* E-Sign Disclosure Box (Informational Blue) */
        .esign-disclosure {
            background: #e3f2fd;
            border: 1px solid var(--info-color);
            border-radius: 12px;
            padding: 16px;
            margin: 24px 0;
            font-size: 14px;
            color: #0d47a1;
        }
        
        /* Mobile-First Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 0;
                background: white;
            }
            
            .container {
                border-radius: 0;
                box-shadow: none;
                margin-bottom: 0;
            }
            
            .header {
                padding: 20px 16px;
            }
            
            .header h1 { font-size: 20px; }
            .header h2 { font-size: 16px; }
            
            .progress-bar { display: block; }
            
            .form-container {
                padding: 20px 16px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 0;
            }
            
            .form-row .form-group {
                margin-bottom: 24px;
            }
        }
        
        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Focus visible for keyboard navigation */
        *:focus-visible {
            outline: 3px solid var(--secondary-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>STATEMENT OF NO LOSS</h1>
            <h2>Reinstatement Request Form</h2>
            <p>Electronic Signature Authorization</p>
            <div class="agency-contact">
                1283 N Bridge St, Elkin NC 28621<br>
                336-835-1993 | Save@BillLayneInsurance.com
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </header>
        
        <form id="noLossForm" class="form-container">
            <!-- Hidden fields for agency/agent info -->
            <input type="hidden" id="hiddenAgencyName" name="agencyName" value="Bill Layne Insurance Agency">
            <input type="hidden" id="hiddenAgencyAddress" name="agencyAddress" value="1283 N Bridge St, Elkin NC 28621">
            <input type="hidden" id="hiddenAgencyEmail" name="agencyEmail" value="Save@BillLayneInsurance.com">
            <input type="hidden" id="hiddenAgencyPhone" name="agencyPhone" value="336-835-1993">
            <input type="hidden" id="hiddenAgentName" name="agentName">
            <input type="hidden" id="hiddenAgentEmail" name="agentEmail">
            
            <!-- Policy Information -->
            <h3 class="section-title">Policy Information</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="insuranceCompany">Insurance Company<span class="required">*</span></label>
                    <select id="insuranceCompany" name="insuranceCompany" required>
                        <option value="">Select Insurance Company</option>
                        <option value="Nationwide">Nationwide</option>
                        <option value="Progressive">Progressive</option>
                        <option value="National General">National General</option>
                        <option value="Alamance">Alamance</option>
                        <option value="Travelers">Travelers</option>
                        <option value="Foremost">Foremost</option>
                        <option value="State Farm">State Farm</option>
                        <option value="Allstate">Allstate</option>
                        <option value="GEICO">GEICO</option>
                        <option value="Liberty Mutual">Liberty Mutual</option>
                        <option value="Farmers">Farmers</option>
                        <option value="USAA">USAA</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="policyNumber">Policy Number<span class="required">*</span></label>
                    <input type="text" id="policyNumber" name="policyNumber" required autocomplete="off">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="policyType">Policy Type<span class="required">*</span></label>
                    <select id="policyType" name="policyType" required>
                        <option value="">Select Policy Type</option>
                        <option value="Auto">Auto Insurance</option>
                        <option value="Home">Homeowners Insurance</option>
                        <option value="Renters">Renters Insurance</option>
                        <option value="Motorcycle">Motorcycle Insurance</option>
                        <option value="RV">RV Insurance</option>
                        <option value="Commercial Auto">Commercial Auto</option>
                        <option value="Business">Business Insurance</option>
                        <option value="Life">Life Insurance</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amountPaid">Total Amount to Reinstate</label>
                    <input type="text" id="amountPaid" name="amountPaid" placeholder="$0.00" inputmode="decimal">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="cancellationDate">Cancellation Date<span class="required">*</span></label>
                    <input type="date" id="cancellationDate" name="cancellationDate" required>
                </div>
                <div class="form-group">
                    <label for="reinstatementDate">Requested Reinstatement Date<span class="required">*</span></label>
                    <input type="date" id="reinstatementDate" name="reinstatementDate" required>
                </div>
            </div>
            
            <!-- Insured Information -->
            <h3 class="section-title">Insured Information</h3>
            <div class="form-group">
                <label for="insuredName">Insured Full Name<span class="required">*</span></label>
                <input type="text" id="insuredName" name="insuredName" required autocomplete="name" data-validate="required">
                <svg class="input-icon valid-icon" viewBox="0 0 24 24"><path fill="var(--success-color)" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" autocomplete="email" data-validate="email">
                    <svg class="input-icon valid-icon" viewBox="0 0 24 24"><path fill="var(--success-color)" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    <svg class="input-icon invalid-icon" viewBox="0 0 24 24"><path fill="var(--error-color)" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number<span class="required">*</span></label>
                    <input type="tel" id="phone" name="phone" required placeholder="(555) 555-5555" inputmode="tel" data-validate="phone">
                    <svg class="input-icon valid-icon" viewBox="0 0 24 24"><path fill="var(--success-color)" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    <svg class="input-icon invalid-icon" viewBox="0 0 24 24"><path fill="var(--error-color)" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </div>
            </div>
            
            <!-- Statement of No Loss -->
            <div class="statement-box">
                <h3>Statement of No Loss</h3>
                <p class="legal-text">I, <strong id="customerNameDisplay">[Customer Name]</strong>, state that neither I nor any other person covered by this policy has had a claim or loss or been involved in an accident since the cancellation or expiration of the policy (the "no loss period").</p>
                <p class="legal-text">I understand the insurance company is relying on this statement to reinstate my policy with no lapse in coverage. If a claim occurred during the no loss period, the reinstatement is null and void, and my policy remains cancelled.</p>
                <p class="fraud-warning">It is a crime to knowingly provide false, incomplete, or misleading information to an insurance company for the purpose of defrauding the company. Penalties include imprisonment, fines, and denial of insurance benefits.</p>
            </div>
            
            <div class="checkbox-container">
                <label>
                    <input type="checkbox" id="noLossConfirmation" name="noLossConfirmation" required>
                    <span class="checkmark"></span>
                    <span>I have read, understand, and agree to the Statement of No Loss. I confirm NO LOSS, damage, or claim has occurred during the lapse period.</span>
                </label>
            </div>
            
            <!-- Optional Acknowledgements -->
            <div class="checkbox-container" id="dmvContainer" style="display: none;">
                <label>
                    <input type="checkbox" id="dmvAcknowledgement" name="dmvAcknowledgement">
                    <span class="checkmark"></span>
                    <span>I acknowledge the DMV may be notified of this policy reinstatement.</span>
                </label>
            </div>
            <div class="checkbox-container" id="mortgageContainer" style="display: none;">
                <label>
                    <input type="checkbox" id="mortgageAcknowledgement" name="mortgageAcknowledgement">
                    <span class="checkmark"></span>
                    <span>I acknowledge my mortgage company may be notified of this policy reinstatement.</span>
                </label>
            </div>
            
            <!-- SMS Consent Checkbox -->
            <div class="checkbox-container consent-highlight">
                <label>
                    <input type="checkbox" id="smsConsent" name="smsConsent">
                    <span class="checkmark"></span>
                    <span><strong>SMS Consent:</strong> I agree to receive one SMS confirmation for this submission. Message and data rates may apply.</span>
                </label>
            </div>
            
            <!-- E-SIGN Act Disclosure and Consent -->
            <div class="esign-disclosure">
                <h4>Electronic Signature Disclosure</h4>
                <p>You are signing this Statement of No Loss electronically. You agree your electronic signature is the legal equivalent of your manual signature. You consent to be legally bound by this document's terms.</p>
            </div>
            
            <div class="checkbox-container esign-highlight">
                <label>
                    <input type="checkbox" id="esignConsent" name="esignConsent" required>
                    <span class="checkmark"></span>
                    <span><strong>Electronic Signature Consent:</strong> I consent to sign this document electronically and agree that my signature is legally binding.</span>
                </label>
            </div>
            
            <!-- Electronic Signature -->
            <h3 class="section-title">✍️ Electronic Signature</h3>
            <div class="form-group">
                <canvas id="signature-pad"></canvas>
                <div class="signature-buttons">
                    <button type="button" class="btn btn-clear" onclick="clearSignature()">Clear Signature</button>
                </div>
            </div>
            
            <input type="hidden" id="signature" name="signature">
            
            <button type="submit" class="btn btn-submit" id="submitBtn">
                Submit Statement of No Loss
            </button>
        </form>
        
        <footer class="footer">
            <img src="https://i.imgur.com/1RmyVju.png" alt="Bill Layne Insurance Logo" class="footer-logo">
            <p>Bill Layne Insurance Agency</p>
            <div class="footer-links">
                <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a>
            </div>
            <p class="powered-by">© 2025 Bill Layne Insurance Agency</p>
        </footer>
    </div>

    <!-- Modals -->
    <div class="success-modal-overlay" id="successModalOverlay">
        <div class="success-modal">
            <div class="success-icon"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
            <h2>Successfully Submitted!</h2>
            <p>Your Statement of No Loss has been received.</p>
            <div class="confirmation-number">Conf #: <span id="confirmNumber"></span></div>
            <button class="btn btn-submit" onclick="closeSuccessModal()">OK</button>
        </div>
    </div>
    <div class="loading-modal-overlay" id="loadingOverlay">
        <div class="loading-modal">
            <div class="spinner"></div>
            <h3>Submitting Your Statement</h3>
            <p>Please keep this window open...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script>
        // BACKEND SCRIPT URL - REMAINS UNCHANGED
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxD6j-pGmC13_X5GTUfIpJPg-HJXIMnzcaUmvo7rEBwd97Cx6alEabi30YJp5S6fqUyEg/exec';
        
        let signaturePad;
        
        // Update progress UI
        function updateProgress() {
            const requiredFields = document.querySelectorAll('[required]');
            let filledFields = 0;
            requiredFields.forEach(field => {
                if (field.type === 'checkbox' ? field.checked : field.value) filledFields++;
            });
            const progress = Math.round((filledFields / requiredFields.length) * 100);
            
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }

            const formProgress = document.getElementById('formProgress');
            if (formProgress) {
                formProgress.textContent = progress + '% Complete';
            }
        }
        
        // Get Device Info for audit trail
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let device = 'Desktop';
            if (/Mobile|Android|iPhone|iPad/i.test(ua)) device = /iPad/i.test(ua) ? 'Tablet' : 'Mobile';
            let os = 'Unknown';
            if (ua.includes('Win')) os = 'Windows';
            if (ua.includes('Mac')) os = 'MacOS';
            if (ua.includes('Linux')) os = 'Linux';
            if (ua.includes('Android')) os = 'Android';
            if (/iPhone|iPad/.test(ua)) os = 'iOS';
            return `${device} - ${os}`;
        }

        // Real-time validation logic
        function validateField(input) {
            const type = input.dataset.validate;
            const parent = input.parentElement;
            let isValid = false;

            if (type === 'required') {
                isValid = input.value.trim() !== '';
            } else if (type === 'email') {
                // simple email regex
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                isValid = emailRegex.test(input.value);
                // only validate if field is not empty
                if(input.value.trim() === '') {
                    parent.classList.remove('is-valid', 'is-invalid');
                    return;
                }
            } else if (type === 'phone') {
                // checks for 10 digits
                isValid = input.value.replace(/\D/g, '').length === 10;
            }

            if(isValid) {
                parent.classList.add('is-valid');
                parent.classList.remove('is-invalid');
            } else {
                parent.classList.add('is-invalid');
                parent.classList.remove('is-valid');
            }
        }
        
        // Auto-fill form from URL parameters
        window.addEventListener('DOMContentLoaded', () => {
            // Pre-fill reinstatement date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reinstatementDate').value = today;

            const urlParams = new URLSearchParams(window.location.search);
            const fields = ['insuredName', 'email', 'phone', 'insuranceCompany', 'policyNumber', 'policyType', 'amountPaid', 'cancellationDate'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (urlParams.has(field) && element) {
                     element.value = decodeURIComponent(urlParams.get(field));
                }
            });

            // Set agent info from URL if provided
            if (urlParams.has('agentName')) document.getElementById('hiddenAgentName').value = urlParams.get('agentName');
            if (urlParams.has('agentEmail')) document.getElementById('hiddenAgentEmail').value = urlParams.get('agentEmail');

            // Show/hide optional acknowledgements based on policy type
            const policyTypeEl = document.getElementById('policyType');
            const handlePolicyTypeChange = () => {
                const type = policyTypeEl.value;
                const isVehicle = ['Auto', 'Motorcycle', 'RV', 'Commercial Auto'].includes(type);
                document.getElementById('dmvContainer').style.display = isVehicle ? 'block' : 'none';
                document.getElementById('mortgageContainer').style.display = type === 'Home' ? 'block' : 'none';
            };
            policyTypeEl.addEventListener('change', handlePolicyTypeChange);
            if (policyTypeEl.value) handlePolicyTypeChange();
            
            // Initialize signature pad
            const canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext('2d').scale(ratio, ratio);
                signaturePad.clear();
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // Add event listeners for progress tracking
            document.querySelectorAll('[required]').forEach(field => {
                field.addEventListener('input', updateProgress);
                field.addEventListener('change', updateProgress);
            });
            updateProgress();

            document.querySelectorAll('[data-validate]').forEach(input => {
                input.addEventListener('input', () => validateField(input));
            });

            // Update customer name in legal text
            const insuredNameEl = document.getElementById('insuredName');
            const customerNameDisplay = document.getElementById('customerNameDisplay');
            const updateNameDisplay = () => {
                customerNameDisplay.textContent = insuredNameEl.value || '[Customer Name]';
            };
            insuredNameEl.addEventListener('input', updateNameDisplay);
            updateNameDisplay();
        });

        function clearSignature() {
            signaturePad.clear();
        }

        function closeSuccessModal() {
            document.getElementById('successModalOverlay').classList.remove('show');
        }
        
        // Handle form submission
        document.getElementById('noLossForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Simple validation
            if (!document.getElementById('noLossConfirmation').checked || !document.getElementById('esignConsent').checked) {
                alert('Please review and check all required consent boxes to proceed.');
                return;
            }
            if (signaturePad.isEmpty()) {
                alert('Please provide your electronic signature.');
                return;
            }
            
            document.getElementById('loadingOverlay').classList.add('show');
            document.getElementById('submitBtn').disabled = true;
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Add signature and audit trail data
            data.signature = signaturePad.toDataURL();
            data.confirmationNumber = 'NOL-' + Date.now();
            data.deviceInfo = getDeviceInfo();
            data.ipAddress = 'Fetching...'; // Placeholder, actual IP fetch can be added if needed
            data.userAgent = navigator.userAgent;
            data.submittedAt = new Date().toISOString();
            
            try {
                // Using 'no-cors' mode; response will be opaque but the request will be sent.
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(data)
                });
                
                document.getElementById('confirmNumber').textContent = data.confirmationNumber;
                document.getElementById('successModalOverlay').classList.add('show');
                
                this.reset();
                signaturePad.clear();
                updateProgress();
                document.getElementById('customerNameDisplay').textContent = '[Customer Name]';

            } catch (error) {
                console.error('Error:', error);
                alert('Failed to submit form. Please contact support.');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('show');
                document.getElementById('submitBtn').disabled = false;
            }
        });
    </script>
</body>
</html>

