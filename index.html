<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statement of No Loss - Bill Layne Insurance</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #667eea;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 10px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        
        .agency-logo {
            max-width: 200px;
            max-height: 80px;
            margin-bottom: 15px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .header h2 {
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .agency-contact {
            font-size: 13px;
            margin-top: 10px;
            opacity: 0.95;
        }
        
        .form-container {
            padding: 30px 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .required {
            color: #dc3545;
            margin-left: 3px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .statement-box {
            background: #f0f4ff;
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
        }
        
        .statement-box h3 {
            color: var(--primary-color);
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .statement-box h3::before {
            content: '📋';
            margin-right: 10px;
            font-size: 24px;
        }
        
        .legal-text {
            color: #333;
            font-size: 14px;
            line-height: 1.8;
            margin-bottom: 15px;
            text-align: justify;
        }
        
        .checkbox-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
        }
        
        .checkbox-container.consent-highlight {
            background: #fffef5;
            border-color: #ffc107;
        }
        
        .checkbox-container.esign-highlight {
            background: #f0f4ff;
            border-color: var(--secondary-color);
        }
        
        .checkbox-container label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            font-weight: 500;
            color: #333;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: auto;
            min-width: 20px;
            margin-right: 12px;
            margin-top: 3px;
            transform: scale(1.3);
            cursor: pointer;
        }
        
        #signature-pad {
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: block;
            width: 100%;
            height: 200px;
            cursor: crosshair;
            background: white;
            touch-action: none;
        }
        
        .signature-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-clear {
            background: #f44336;
            color: white;
            flex: 1;
        }
        
        .btn-clear:hover {
            background: #da190b;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            width: 100%;
            margin-top: 20px;
            font-size: 18px;
            padding: 15px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            margin: 20px 0;
        }
        
        .loading-box {
            background: white;
            border: 2px solid #1e3c72;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 0 auto;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .warning-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .success-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
        }
        
        .success-modal-overlay.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .success-modal {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .success-icon svg {
            width: 40px;
            height: 40px;
            stroke: white;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .confirmation-number {
            background: #f0f4ff;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-family: monospace;
            font-size: 16px;
            color: #667eea;
            font-weight: 600;
        }
        
        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
        }
        
        .footer-logo {
            max-width: 150px;
            margin-bottom: 10px;
        }
        
        .footer-links {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            font-size: 13px;
        }
        
        .footer-links a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 10px;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }
        
        .powered-by {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #999;
        }
        
        .error-message {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .esign-disclosure {
            background: #e3f2fd;
            border: 1px solid #1976d2;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 13px;
            color: #0d47a1;
        }
        
        @media (max-width: 600px) {
            .header h1 { font-size: 20px; }
            .header h2 { font-size: 16px; }
            .form-container { padding: 20px 15px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>STATEMENT OF NO LOSS</h1>
            <h2>Reinstatement Request Form</h2>
            <p>Electronic Signature Authorization</p>
            <div class="agency-contact">
                1283 N Bridge St, Elkin NC 28621<br>
                336-835-1993 | Save@BillLayneInsurance.com
            </div>
        </div>
        
        <form id="noLossForm" class="form-container">
            <!-- Hidden fields for agency/agent info - Bill Layne Insurance defaults -->
            <input type="hidden" id="hiddenAgencyName" name="agencyName" value="Bill Layne Insurance Agency">
            <input type="hidden" id="hiddenAgencyAddress" name="agencyAddress" value="1283 N Bridge St, Elkin NC 28621">
            <input type="hidden" id="hiddenAgencyEmail" name="agencyEmail" value="Save@BillLayneInsurance.com">
            <input type="hidden" id="hiddenAgencyPhone" name="agencyPhone" value="336-835-1993">
            <input type="hidden" id="hiddenAgentName" name="agentName">
            <input type="hidden" id="hiddenAgentEmail" name="agentEmail">
            
            <!-- Policy Information -->
            <h3 class="section-title">Policy Information</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="insuranceCompany">Insurance Company<span class="required">*</span></label>
                    <select id="insuranceCompany" name="insuranceCompany" required>
                        <option value="">Select Insurance Company</option>
                        <option value="Nationwide">Nationwide</option>
                        <option value="Progressive">Progressive</option>
                        <option value="National General">National General</option>
                        <option value="Alamance">Alamance</option>
                        <option value="Travelers">Travelers</option>
                        <option value="Foremost">Foremost</option>
                        <option value="State Farm">State Farm</option>
                        <option value="Allstate">Allstate</option>
                        <option value="GEICO">GEICO</option>
                        <option value="Liberty Mutual">Liberty Mutual</option>
                        <option value="Farmers">Farmers</option>
                        <option value="USAA">USAA</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="policyNumber">Policy Number<span class="required">*</span></label>
                    <input type="text" id="policyNumber" name="policyNumber" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="policyType">Policy Type<span class="required">*</span></label>
                    <select id="policyType" name="policyType" required>
                        <option value="">Select Policy Type</option>
                        <option value="Auto">Auto Insurance</option>
                        <option value="Home">Homeowners Insurance</option>
                        <option value="Renters">Renters Insurance</option>
                        <option value="Motorcycle">Motorcycle Insurance</option>
                        <option value="RV">RV Insurance</option>
                        <option value="Commercial Auto">Commercial Auto</option>
                        <option value="Business">Business Insurance</option>
                        <option value="Life">Life Insurance</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="amountPaid">Total Amount Required to Reinstate</label>
                    <input type="text" id="amountPaid" name="amountPaid" placeholder="$0.00">
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        * Fees included in Total Amount Required to Reinstate
                    </small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="cancellationDate">Cancellation/Lapse Date<span class="required">*</span></label>
                    <input type="date" id="cancellationDate" name="cancellationDate" required>
                </div>
                
                <div class="form-group">
                    <label for="reinstatementDate">Requested Reinstatement Date<span class="required">*</span></label>
                    <input type="date" id="reinstatementDate" name="reinstatementDate" required>
                </div>
            </div>
            
            <!-- Insured Information -->
            <h3 class="section-title">Insured Information</h3>
            
            <div class="form-group">
                <label for="insuredName">Insured Name (Full Name)<span class="required">*</span></label>
                <input type="text" id="insuredName" name="insuredName" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email">
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number<span class="required">*</span></label>
                    <input type="tel" id="phone" name="phone" required placeholder="(336) 555-1234">
                </div>
            </div>
            
            <div class="form-group">
                <label for="propertyAddress">Property/Garaging Address<span class="required">*</span></label>
                <input type="text" id="propertyAddress" name="propertyAddress" placeholder="123 Main Street" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="city">City<span class="required">*</span></label>
                    <input type="text" id="city" name="city" required>
                </div>
                
                <div class="form-group">
                    <label for="state">State<span class="required">*</span></label>
                    <select id="state" name="state" required>
                        <option value="">Select State</option>
                        <option value="NC">North Carolina</option>
                        <option value="SC">South Carolina</option>
                        <option value="VA">Virginia</option>
                        <option value="GA">Georgia</option>
                        <option value="TN">Tennessee</option>
                        <option value="FL">Florida</option>
                        <option value="AL">Alabama</option>
                        <option value="MS">Mississippi</option>
                        <option value="LA">Louisiana</option>
                        <option value="TX">Texas</option>
                        <option value="KY">Kentucky</option>
                        <option value="WV">West Virginia</option>
                        <option value="MD">Maryland</option>
                        <option value="DE">Delaware</option>
                        <option value="PA">Pennsylvania</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="zipCode">ZIP Code<span class="required">*</span></label>
                <input type="text" id="zipCode" name="zipCode" maxlength="5" pattern="[0-9]{5}" required>
            </div>
            
            <!-- Statement of No Loss -->
            <div class="statement-box">
                <h3>Statement of No Loss</h3>
                
                <p class="legal-text">
                    I, <span id="customerNameDisplay" style="font-weight: bold;">[Customer Name]</span>, state that neither I nor any other person covered by this policy has had a claim or loss or been involved in an accident
                    since the cancellation or expiration of the policy (otherwise known as the "no loss period") wherein this policy, including any and all
                    coverages endorsed upon or made part of the policy may apply.
                </p>
                <p class="legal-text">
                    In addition, if this reinstatement is for a personal or commercial auto, motorcycle, or RV policy, I certify that I have disclosed the current
                    garaging location and use of all insured vehicles including if any such vehicle is used to deliver food or goods, to transport people for
                    compensation, or for any other business purpose. I have also disclosed household members who are age 14 or older, and all persons who
                    regularly drive any vehicle insured under this policy.
                </p>
                <p class="legal-text">
                    I understand that this insurance company is relying solely upon this Statement of No Loss all of which is material, as an inducement to
                    reinstate my policy with no lapse in coverage. I further understand that if a claim, loss, or accident has occurred during the no loss period, or
                    if I failed to disclose the current garaging location and primary use of all vehicles insured under this policy, all persons who regularly drive
                    these vehicles, and all members of my household who are age 14 or older, the reinstatement is null and void, my policy remains cancelled
                    and no insurance coverage shall be provided.
                </p>
                <p class="legal-text">
                    I agree that if my check or other payment for this reinstatement is not honored for any reason, the reinstatement is null and void and no
                    coverage shall exist under this policy. I agree to pay a reinstatement fee and late fee (if applicable) in addition to the premium required to
                    reinstate my policy. My payment will be applied first to the reinstatement and late fee and the remainder to the premium.
                </p>
                <p class="legal-text" style="color: #cc0000; font-style: italic; font-weight: 600; background: #fff5f5; padding: 10px; border-radius: 5px; margin-top: 15px;">
                    It is a crime to knowingly provide false, incomplete, or misleading information to an insurance company for the purpose of defrauding the
                    company. Penalties include imprisonment, fines, and denial of insurance benefits.
                </p>
            </div>
            
            <div class="checkbox-container">
                <label>
                    <input type="checkbox" id="noLossConfirmation" name="noLossConfirmation" required>
                    <span>I have read, understand, and agree to all the statements, terms, and conditions outlined above in the Statement of No Loss. I confirm that NO LOSS, damage, or claim has occurred during the lapse period.</span>
                </label>
            </div>
            
            <!-- DMV and Mortgage Optional Acknowledgements -->
            <div class="checkbox-container" id="dmvContainer" style="display: none;">
                <label>
                    <input type="checkbox" id="dmvAcknowledgement" name="dmvAcknowledgement">
                    <span>I acknowledge that the DMV may be notified of this policy reinstatement.</span>
                </label>
            </div>
            
            <div class="checkbox-container" id="mortgageContainer" style="display: none;">
                <label>
                    <input type="checkbox" id="mortgageAcknowledgement" name="mortgageAcknowledgement">
                    <span>I acknowledge that my mortgage company may be notified of this policy reinstatement.</span>
                </label>
            </div>
            
            <!-- NEW: SMS Consent Checkbox -->
            <div class="checkbox-container consent-highlight">
                <label>
                    <input type="checkbox" id="smsConsent" name="smsConsent">
                    <span><strong>SMS Notification Consent:</strong> I agree to receive one SMS confirmation message about this Statement of No Loss at the phone number provided. Message and data rates may apply. Reply STOP to opt out. Reply HELP for assistance.</span>
                </label>
            </div>
            
            <!-- NEW: E-SIGN Act Disclosure and Consent -->
            <div class="esign-disclosure">
                <h4 style="margin-bottom: 10px;">Electronic Signature Disclosure</h4>
                <p>By providing your electronic signature below, you are signing this Statement of No Loss electronically. You agree your electronic signature is the legal equivalent of your manual signature on this document. You consent to be legally bound by this document's terms and conditions.</p>
                <p style="margin-top: 10px;">This document will be stored electronically and you will receive a copy via email (if provided) for your records. The document is created and stored in compliance with the federal Electronic Signatures in Global and National Commerce Act (E-SIGN Act) and the Uniform Electronic Transactions Act (UETA).</p>
            </div>
            
            <div class="checkbox-container esign-highlight">
                <label>
                    <input type="checkbox" id="esignConsent" name="esignConsent" required>
                    <span><strong>Electronic Signature Consent:</strong> I consent to sign this document electronically and agree that my electronic signature is legally binding. I understand I have the right to receive a paper copy of this document and waive that right by choosing to sign electronically.</span>
                </label>
            </div>
            
            <!-- Electronic Signature -->
            <h3 class="section-title">Electronic Signature</h3>
            
            <div class="form-group">
                <label>Please sign below using your mouse or finger<span class="required">*</span></label>
                <canvas id="signature-pad"></canvas>
                <div class="signature-buttons">
                    <button type="button" class="btn btn-clear" onclick="clearSignature()">Clear Signature</button>
                </div>
            </div>
            
            <input type="hidden" id="signature" name="signature">
            
            <div class="error-message" id="errorMessage"></div>
            
            <div class="loading" id="loading">
                <div class="loading-box">
                    <div class="spinner"></div>
                    <h3 style="color: #1e3c72; margin: 20px 0 10px 0;">Submitting Your Statement</h3>
                    <p style="font-size: 16px; color: #333; margin-bottom: 10px;">Please wait while we process your form...</p>
                    <p class="warning-pulse" style="color: #dc3545; font-weight: 600; font-size: 14px;">
                        ⚠️ Please keep this window open until you see the confirmation
                    </p>
                    <p style="color: #666; font-size: 13px; margin-top: 10px;">
                        This usually takes 5-10 seconds
                    </p>
                </div>
            </div>
            
            <button type="submit" class="btn btn-submit" id="submitBtn">
                Submit Statement of No Loss
            </button>
        </form>
        
        <div class="footer">
            <img src="https://i.imgur.com/cBAgeX8.png" alt="Bill Layne Insurance" class="footer-logo">
            <div>
                Bill Layne Insurance Agency<br>
                1283 N Bridge St, Elkin NC 28621<br>
                336-835-1993 | Save@BillLayneInsurance.com
            </div>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
                <a href="#">SMS Terms</a>
            </div>
            <div class="powered-by">
                By submitting this form, you consent to electronic records per the E-SIGN Act and UETA.<br>
                Powered by MyNoLossForm.com | © 2025 Bill Layne Insurance Agency
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal-overlay" id="successModalOverlay">
        <div class="success-modal">
            <div class="success-icon">
                <svg viewBox="0 0 24 24">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <h2>Successfully Submitted!</h2>
            <p>Your Statement of No Loss has been received and processed successfully.</p>
            <div class="confirmation-number">
                Confirmation #: <span id="confirmNumber"></span>
            </div>
            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                ✓ Email confirmation sent (if provided)<br>
                <span id="smsConfirmStatus">✓ SMS confirmation sent to your phone</span><br>
                ✓ PDF generated with audit trail<br>
                ✓ Securely stored and transmitted
            </p>
            <button class="btn btn-submit" onclick="closeSuccessModal()">OK</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script>
        // YOUR GOOGLE APPS SCRIPT URL - ACTIVE AND READY
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxD6j-pGmC13_X5GTUfIpJPg-HJXIMnzcaUmvo7rEBwd97Cx6alEabi30YJp5S6fqUyEg/exec';
        
        let signaturePad;
        
        // Get Device Info
        function getDeviceInfo() {
            const userAgent = navigator.userAgent;
            let deviceType = 'Desktop';
            let os = 'Unknown OS';
            let browser = 'Unknown Browser';
            
            if (/Mobile|Android|iPhone|iPad/i.test(userAgent)) {
                deviceType = /iPad/i.test(userAgent) ? 'Tablet' : 'Mobile';
            }
            
            if (userAgent.indexOf('Win') !== -1) os = 'Windows';
            else if (userAgent.indexOf('Mac') !== -1) os = 'MacOS';
            else if (userAgent.indexOf('Linux') !== -1) os = 'Linux';
            else if (userAgent.indexOf('Android') !== -1) os = 'Android';
            else if (/iPhone|iPad|iPod/.test(userAgent)) os = 'iOS';
            
            if (userAgent.indexOf('Chrome') !== -1 && userAgent.indexOf('Edg') === -1) browser = 'Chrome';
            else if (userAgent.indexOf('Safari') !== -1 && userAgent.indexOf('Chrome') === -1) browser = 'Safari';
            else if (userAgent.indexOf('Firefox') !== -1) browser = 'Firefox';
            else if (userAgent.indexOf('Edg') !== -1) browser = 'Edge';
            
            return `${deviceType} - ${os} - ${browser}`.trim();
        }
        
        // Generate Browser Fingerprint
        function generateBrowserFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fingerprint', 2, 2);
            
            let fingerprint = canvas.toDataURL();
            fingerprint = fingerprint.substring(0, 50).replace(/[^a-zA-Z0-9]/g, '');
            
            const screenData = `${screen.width}x${screen.height}x${screen.colorDepth}`;
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const plugins = navigator.plugins.length;
            
            return `FP-${fingerprint}-${screenData.replace(/[^0-9]/g, '')}-${plugins}`.substring(0, 50);
        }
        
        // Get IP Address
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('Could not fetch IP:', error);
                return 'Unable to capture';
            }
        }
        
        // Parse URL parameters and auto-fill form
        window.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Pre-fill customer form fields from URL parameters
            const fieldMappings = {
                'insuredName': 'insuredName',
                'email': 'email',
                'phone': 'phone',
                'propertyAddress': 'propertyAddress',
                'city': 'city',
                'state': 'state',
                'zipCode': 'zipCode',
                'insuranceCompany': 'insuranceCompany',
                'policyNumber': 'policyNumber',
                'policyType': 'policyType',
                'amountPaid': 'amountPaid',
                'cancellationDate': 'cancellationDate',
                'reinstatementDate': 'reinstatementDate'
            };
            
            // Process all URL parameters
            Object.keys(fieldMappings).forEach(param => {
                const value = urlParams.get(param);
                if (value) {
                    const elementId = fieldMappings[param];
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = decodeURIComponent(value);
                    }
                }
            });
            
            // Set agent info from URL if provided
            const agentName = urlParams.get('agentName');
            const agentEmail = urlParams.get('agentEmail');
            if (agentName) document.getElementById('hiddenAgentName').value = agentName;
            if (agentEmail) document.getElementById('hiddenAgentEmail').value = agentEmail;
            
            // Show/hide optional acknowledgements based on policy type
            const policyTypeElement = document.getElementById('policyType');
            policyTypeElement.addEventListener('change', function() {
                const policyType = this.value;
                // Show DMV acknowledgement for Auto policies
                document.getElementById('dmvContainer').style.display = 
                    (policyType === 'Auto' || policyType === 'Motorcycle' || policyType === 'RV' || policyType === 'Commercial Auto') ? 'block' : 'none';
                // Show Mortgage acknowledgement for Home policies    
                document.getElementById('mortgageContainer').style.display = 
                    (policyType === 'Home') ? 'block' : 'none';
            });
            
            // Trigger change event if policy type is pre-filled
            if (policyTypeElement.value) {
                policyTypeElement.dispatchEvent(new Event('change'));
            }
            
            // Initialize signature pad
            initSignaturePad();
            
            // Update customer name in statement
            updateCustomerNameDisplay();
            
            // Pre-fetch IP address
            window.userIPAddress = await getIPAddress();
        });
        
        // Update customer name in the legal text
        document.getElementById('insuredName').addEventListener('input', updateCustomerNameDisplay);
        
        function updateCustomerNameDisplay() {
            const name = document.getElementById('insuredName').value || '[Customer Name]';
            document.getElementById('customerNameDisplay').textContent = name;
        }
        
        // Initialize signature pad
        function initSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)'
            });
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }
        
        function resizeCanvas() {
            const canvas = document.getElementById('signature-pad');
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            if (signaturePad) {
                signaturePad.clear();
            }
        }
        
        function clearSignature() {
            signaturePad.clear();
        }
        
        function closeSuccessModal() {
            document.getElementById('successModalOverlay').classList.remove('show');
        }
        
        // Handle form submission
        document.getElementById('noLossForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate agreement checkbox
            if (!document.getElementById('noLossConfirmation').checked) {
                alert('Please check the box to confirm you have read and agree to the Statement of No Loss.');
                return;
            }
            
            // Validate E-Sign consent
            if (!document.getElementById('esignConsent').checked) {
                alert('Please consent to electronic signature to proceed.');
                return;
            }
            
            // Validate signature
            if (signaturePad.isEmpty()) {
                alert('Please provide your signature before submitting.');
                return;
            }
            
            // Get signature data
            document.getElementById('signature').value = signaturePad.toDataURL();
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('errorMessage').style.display = 'none';
            
            // Prepare form data
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Add optional acknowledgements (empty string if not checked)
            data.dmvAcknowledgement = document.getElementById('dmvAcknowledgement').checked ? 'Yes' : '';
            data.mortgageAcknowledgement = document.getElementById('mortgageAcknowledgement').checked ? 'Yes' : '';
            
            // Add consent checkboxes
            data.smsConsent = document.getElementById('smsConsent').checked ? 'true' : 'false';
            data.esignConsent = document.getElementById('esignConsent').checked ? 'true' : 'false';
            data.consentTimestamp = new Date().toISOString();
            
            // Generate confirmation number
            const confirmationNumber = 'NOL-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            // Generate session ID
            const sessionId = 'NOL-SESSION-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
            
            // Add verification data
            data.confirmationNumber = confirmationNumber;
            data.sessionId = sessionId;
            data.browserFingerprint = generateBrowserFingerprint();
            data.deviceInfo = getDeviceInfo();
            data.screenResolution = `${window.screen.width}x${window.screen.height}`;
            data.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            data.signatureDateTime = new Date().toLocaleString();
            data.signatureTime = new Date().toLocaleTimeString();
            data.userAgent = navigator.userAgent;
            data.formVersion = 'v6.0-Secure';
            data.submissionMethod = 'Online Portal - MyNoLossForm';
            data.ipAddress = window.userIPAddress || 'Unable to capture';
            
            // Add signature metadata
            data.signatureMetadata = JSON.stringify({
                cookiesEnabled: navigator.cookieEnabled,
                onlineStatus: navigator.onLine,
                languages: navigator.languages ? navigator.languages.join(', ') : navigator.language,
                platform: navigator.platform,
                hardwareConcurrency: navigator.hardwareConcurrency || 'N/A',
                deviceMemory: navigator.deviceMemory || 'N/A',
                maxTouchPoints: navigator.maxTouchPoints || 0,
                colorDepth: screen.colorDepth,
                timezoneOffset: new Date().getTimezoneOffset(),
                plugins: Array.from(navigator.plugins || []).map(p => p.name).join(', ') || 'None'
            });
            
            // Add signature URL and timestamps
            data.signatureUrl = document.getElementById('signature').value;
            data.submittedAt = new Date().toISOString();
            data.browserInfo = navigator.userAgent;

            try {
                // Submit to Google Apps Script
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                // Update SMS confirmation status in modal
                const smsStatus = document.getElementById('smsConsent').checked ? 
                    '✓ SMS confirmation sent to your phone' : 
                    '✓ SMS notification skipped (no consent given)';
                document.getElementById('smsConfirmStatus').textContent = smsStatus;
                
                // Show success modal
                document.getElementById('confirmNumber').textContent = confirmationNumber;
                document.getElementById('successModalOverlay').classList.add('show');
                
                // Reset form
                this.reset();
                signaturePad.clear();
                updateCustomerNameDisplay();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorMessage').textContent = 'Failed to submit form. Please try again or contact support at 336-835-1993.';
                document.getElementById('errorMessage').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
            }
        });
        
        // Auto-format phone number
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 3) {
                    value = '(' + value;
                } else if (value.length <= 6) {
                    value = '(' + value.slice(0, 3) + ') ' + value.slice(3);
                } else {
                    value = '(' + value.slice(0, 3) + ') ' + value.slice(3, 6) + '-' + value.slice(6, 10);
                }
            }
            e.target.value = value;
        });
        
        // Auto-format amount
        document.getElementById('amountPaid').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d.]/g, '');
            if (value && !e.target.value.startsWith('$')) {
                e.target.value = '$' + value;
            }
        });
        
        // ZIP code validation
        document.getElementById('zipCode').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5);
        });
    </script>
</body>
</html>
